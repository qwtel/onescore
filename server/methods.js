// Generated by CoffeeScript 1.3.3
(function() {
  var calculateScore, countVotes, updateScore;

  countVotes = function(id, up) {
    return Votes.find({
      entity: id,
      up: up
    }).count();
  };

  calculateScore = function(id) {
    var down, up;
    up = countVotes(id, true);
    down = countVotes(id, false);
    return up - down;
  };

  updateScore = function(collection, id, score, callback) {
    return collection.update(id, {
      $set: {
        score: score
      }
    }, callback);
  };

  Meteor.methods({
    updateAchievementScore: function(id) {
      var score;
      score = calculateScore(id);
      return updateScore(Achievements, id, score);
    },
    updateTitleScore: function(titleId, achievementId) {
      var score;
      score = calculateScore(titleId);
      return updateScore(Titles, titleId, score, function() {
        var best;
        best = Titles.findOne({
          entity: achievementId
        }, {
          sort: {
            score: -1
          }
        });
        if (best) {
          return Achievements.update(achievementId, {
            $set: {
              title: best.title
            }
          });
        }
      });
    }
  });

}).call(this);
