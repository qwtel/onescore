// Generated by CoffeeScript 1.3.3
(function() {

  Meteor.startup(function() {
    var rank, users;
    users = Meteor.users.find({}, {
      sort: {
        score: -1
      }
    });
    rank = 1;
    users.forEach(function(user) {
      Meteor.users.update(user._id, {
        $set: {
          rank: rank
        }
      });
      return rank++;
    });
    users.observe({
      added: function(user) {
        var options, url,
          _this = this;
        url = "https://graph.facebook.com/" + user.services.facebook.id;
        options = {
          params: {
            access_token: user.services.facebook.accessToken
          }
        };
        return Meteor.http.get(url, options, function(error, res) {
          return Meteor.users.update(user._id, {
            $set: {
              username: res.data.username,
              bio: res.data.bio,
              location: res.data.location.name
            }
          });
        });
      },
      moved: function(user, oldRank, newRank) {
        return Meteor.users.update(user._id, {
          $set: {
            rank: newRank
          }
        });
      }
    });
    return Titles.find().observe({
      changed: function(title) {
        var achievementId, best;
        achievementId = title.entity;
        best = Titles.findOne({
          entity: achievementId
        }, {
          sort: {
            score: -1
          }
        });
        if (best) {
          return Achievements.update(achievementId, {
            $set: {
              title: best.title
            }
          });
        }
      }
    });
    /*
      Titles.find().observe
        added: (entity) ->
          Titles.update entity._id,
            $set:
              type: 'title'
    
      Achievements.find().observe
        added: (entity) ->
          Achievements.update entity._id,
            $set:
              type: 'achievement'
    
      Accomplishments.find().observe
        added: (entity) ->
          Accomplishments.update entity._id,
            $set:
              type: 'accomplishment'
    
      Votes.find().observe
        added: (entity) ->
          Votes.update entity._id,
            $set:
              type: 'vote'
    
      Comments.find().observe
        added: (entity) ->
          Comments.update entity._id,
            $set:
              type: 'comment'
    */

  });

}).call(this);
