// Generated by CoffeeScript 1.3.3
var fetchUserInformation, nextLevel;

fetchUserInformation = function(user) {
  var options, url,
    _this = this;
  url = "https://graph.facebook.com/" + user.services.facebook.id;
  options = {
    params: {
      access_token: user.services.facebook.accessToken
    }
  };
  return Meteor.http.get(url, options, function(error, res) {
    return Meteor.users.update(user._id, {
      $set: {
        username: res.data.username,
        bio: res.data.bio,
        location: res.data.location.name
      }
    });
  });
};

nextLevel = function(level) {
  var next;
  next = 0;
  switch (level) {
    case 1:
      next = 10;
      break;
    case 2:
      next = 25;
      break;
    case 3:
      next = 125;
      break;
    case 4:
      next = 525;
      break;
    case 5:
      next = 1225;
  }
  return next;
};

Meteor.startup(function() {
  var users;
  users = Meteor.users.find({}, {
    sort: {
      score: -1
    }
  });
  users.observe({
    added: function(user, beforeIndex) {
      if (user.username == null) {
        Meteor.users.update(user._id, {
          $set: {
            level: 1,
            score: 0,
            rank: beforeIndex + 1
          }
        });
      }
      return fetchUserInformation(user);
    },
    changed: function(user) {
      var next;
      next = nextLevel(user.level);
      if (user.score >= next) {
        return Meteor.users.update(user._id, {
          $inc: {
            level: 1
          }
        });
      }
    },
    moved: function(user, oldRank, newRank) {
      return Meteor.users.update(user._id, {
        $set: {
          rank: newRank
        }
      });
    }
  });
  return Titles.find().observe({
    changed: function(title) {
      return Meteor.call('assignBestTitle', title);
    }
  });
});
